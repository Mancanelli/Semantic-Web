<!DOCTYPE html>
<html>

    <head>
        <title><%= title %></title>

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <link rel='stylesheet' href='/stylesheets/music.css'>

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
        <script src="https://rawgit.com/unconditional/jquery-table2excel/master/src/jquery.table2excel.js"></script>

        <script>
            $(document).ready(function() {
                var table = "#tableID";

                $('#rowsID').change(function() {
                    var num = 0;
                    var maxRows = parseInt($(this).val());
                    var totalRows = $(table + ' tbody tr').length;
                    $('.pagination').html('');

                    $(table + ' tr:gt(0)').each(function() {
                        num++;
                        if(num > maxRows)
                            $(this).hide();
                        else
                            $(this).show();
                    });

                    if(totalRows > maxRows) {
                        var pagenum = Math.ceil(totalRows/maxRows);
                        for(var i = 1; i <= pagenum; i++)
                            $('.pagination').append('<li class="page-item" data-page="' + i + '"><a class="page-link" href="#">' + i + '</a></li>').show();
                    }

                    $('.pagination li:first-child').addClass('active');

                    $('.pagination li').click(function() {
                        var pageNum = parseInt($(this).attr('data-page'));
                        var index = 0;

                        $('.pagination li').removeClass('active');
                        $(this).addClass('active');

                        $(table + ' tr:gt(0)').each(function() {
                            index++;
                            if(index > (maxRows*pageNum) || index <= ((maxRows*pageNum)-maxRows))
                                $(this).hide();
                            else
                                $(this).show();
                        });
                    });
                });

                $('#search').keyup(function() {
                    var searchTerm = $(this).val();
                    var maxRows = parseInt($('#rowsID').val());
                    var count = 0;

                    $('.pagination').html('');

                    $(table + ' tr:gt(0)').each(function() {
                        var found = 'false';

                        $(this).each(function() {
                            if($(this).text().toLowerCase().indexOf(searchTerm.toLowerCase()) >= 0)
                                found = 'true';
                        });

                        if(found == 'true') {
                            count++;
                            if(count <= maxRows)
                                $(this).show();
                            else
                                $(this).hide();
                        }
                        else
                            $(this).hide();
                    });

                    if(count == 1)
                        $('.counter').text(count + " result");
                    else
                        $('.counter').text(count + " results");

                    if(count > maxRows) {
                        var pagenum = Math.ceil(count / maxRows);
                        for(var i = 1; i <= pagenum; i++)
                            $('.pagination').append('<li class="page-item" data-page="' + i + '"><a class="page-link" href="#">' + i + '</a></li>').show();
                    }

                    $('.pagination li:first-child').addClass('active');

                    $('.pagination li').click(function() {
                        var pageNum = parseInt($(this).attr('data-page'));
                        var index = 0;

                        $('.pagination li').removeClass('active');
                        $(this).addClass('active');

                        $(table + ' tr:gt(0)').each(function() {
                            var found = 'false';

                            $(this).each(function() {
                                if($(this).text().toLowerCase().indexOf(searchTerm.toLowerCase()) >= 0)
                                    found = 'true';
                            });

                            if(found == 'true')
                                index++;

                            if(found == 'true' && (index > (maxRows*pageNum) || index <= ((maxRows*pageNum)-maxRows)))
                                $(this).show();
                            else
                                $(this).hide();
                        });
                    });
                });

                $(function() {
                    $("#rowsID").trigger("change");

                    $('table tr:eq(0)').prepend('<th>ID</th>');
                    var id = 0;

                    $('table tr:gt(0)').each(function() {
                        id++;
                        $(this).prepend('<td>' + id + '</td>');
                    });

                    $('#btn').click(function() {
                        $(table).table2excel({
                            name: "My Data",
                            filename: "mydata"
                        });
                    });
                });
            });
        </script>
    </head>

    <body>
        <br>

        <div class="container">
            <div class="title">
                <%= title %>
            </div>

            <div class="form-group div-row">
                <select class="form-control" name="state" id="rowsID">
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="100000">Show All</option>
                </select>
            </div>

            <div class="form-group div-search">
                <input type="text" class="search form-control" placeholder="Search here..." id="search">
                <span class="counter"></span>
            </div>

            <table class="table table-striped table-bordered table-hover" id="tableID">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Artist</th>
                        <th>Year</th>
                    </tr>
                </thead>

                <tbody>
                    <% for (var i = 0; i < data.length; i++) { %>
                    <%     var url = "/music/" + data[i].album_uri %>
                    <tr>
                        <td><a href="<%= url %>"><%= data[i].title %></a></td>
                        <td><%= data[i].artist %></td>
                        <td><%= data[i].year %></td>
                    </tr>
                    <% } %>
                </tbody>
            </table>

            <div class="pagination-container">
                <nav class="table-responsive mb-2">
                    <ul class="pagination mb-1"></ul>
                </nav>
            </div>

            <button id="btn" class="btn btn-success">Export to Excel</button>
        </div>

    </body>

</html>
